<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro-Player HTML vMaster 3.0</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        :root {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
        }

        html.dark {
            color-scheme: dark;
        }

        body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        html.dark ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        html.dark ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.5);
        }

        html.dark ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Video Container */
        .video-container {
            position: relative;
            background: #000;
            aspect-ratio: 16/9;
            width: 100%;
            overflow: hidden;
        }

        .video-container.theater-mode {
            aspect-ratio: unset;
            height: 80vh;
        }

        /* Fullscreen landscape optimization for mobile */
        @media (max-width: 1024px) {
            .video-container:fullscreen {
                width: 100vw;
                height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .video-container:fullscreen video {
                width: 100vw;
                height: 100vh;
                object-fit: contain;
            }

            /* Force landscape layout in fullscreen */
            @media (orientation: portrait) {
                .video-container:fullscreen {
                    transform: rotate(90deg);
                    transform-origin: center center;
                    width: 100vh;
                    height: 100vw;
                    position: fixed;
                    top: 0;
                    left: 0;
                }

                .video-container:fullscreen video {
                    width: 100vh;
                    height: 100vw;
                }

                .video-container:fullscreen .controls {
                    width: 100vh;
                }
            }
        }

        /* Glassmorphism */
        .glass {
            backdrop-filter: blur(12px);
            background: rgba(0, 0, 0, 0.7);
        }

        /* Controls */
        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .controls.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
        }

        /* Progress Bar */
        .progress-container {
            position: relative;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            cursor: pointer;
            margin-bottom: 0.75rem;
            transition: height 0.2s ease;
        }

        .progress-container:hover {
            height: 8px;
        }

        .progress-buffered {
            position: absolute;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            transition: width 0.2s ease;
        }

        .progress-bar {
            position: absolute;
            height: 100%;
            background: var(--primary-color);
            border-radius: 3px;
            transition: width 0.1s ease;
        }

        .progress-handle {
            position: absolute;
            top: 50%;
            right: -6px;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .progress-container:hover .progress-handle {
            opacity: 1;
        }

        /* Time Tooltip */
        .time-tooltip {
            position: absolute;
            bottom: 12px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            white-space: nowrap;
        }

        .progress-container:hover .time-tooltip {
            opacity: 1;
        }

        /* Volume Slider */
        .volume-slider {
            width: 0;
            overflow: hidden;
            transition: width 0.3s ease;
        }

        .volume-control:hover .volume-slider {
            width: 80px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-track {
            background: rgba(255, 255, 255, 0.3);
            height: 4px;
            border-radius: 2px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: white;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            margin-top: -4px;
        }

        input[type="range"]::-moz-range-track {
            background: rgba(255, 255, 255, 0.3);
            height: 4px;
            border-radius: 2px;
        }

        input[type="range"]::-moz-range-thumb {
            background: white;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            border: none;
        }

        /* Buttons */
        .control-btn {
            color: white;
            background: transparent;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 2.5rem;
            min-height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Play Button Overlay */
        .play-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
        }

        .play-overlay:hover {
            background: rgba(59, 130, 246, 0.8);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .play-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Spinner */
        .spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .spinner.hidden {
            display: none;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: absolute;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            backdrop-filter: blur(12px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 50;
        }

        .notification.show {
            opacity: 1;
        }

        /* Popup Menu */
        .popup-menu {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            min-width: 150px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            transition: all 0.2s ease;
            z-index: 100;
        }

        .popup-menu.show {
            opacity: 1;
            pointer-events: all;
            transform: translateY(0);
        }

        .popup-menu-item {
            padding: 0.75rem 1rem;
            color: white;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .popup-menu-item:hover {
            background: rgba(59, 130, 246, 0.5);
        }

        .popup-menu-item.active {
            background: rgba(59, 130, 246, 0.8);
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: white;
            width: 100%;
            max-height: 80vh;
            border-radius: 1rem 1rem 0 0;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        html.dark .modal-content {
            background: #1f2937;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        /* Mobile Buttons */
        .mobile-btn {
            position: fixed;
            bottom: 1rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 100;
        }

        .mobile-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .mobile-btn:active {
            transform: scale(0.95);
        }

        .mobile-btn-playlist {
            right: 5rem;
        }

        .mobile-btn-history {
            right: 1rem;
        }

        @media (min-width: 1024px) {
            .mobile-btn {
                display: none;
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Touch Optimization */
        @media (max-width: 1024px) {
            .control-btn {
                min-width: 2.75rem;
                min-height: 2.75rem;
                padding: 0.5rem;
            }

            .progress-container {
                height: 10px;
                margin-bottom: 1rem;
            }

            .progress-handle {
                width: 18px;
                height: 18px;
                right: -9px;
                opacity: 1;
            }

            .controls {
                padding: 0.75rem 0.5rem;
            }

            /* Time display more compact on mobile */
            #timeDisplay {
                font-size: 0.875rem;
                min-width: fit-content;
            }

            /* Speed and subtitle buttons text size */
            #speedBtn span {
                font-size: 0.875rem;
            }

            /* Hide volume slider on mobile completely */
            .volume-control .volume-slider {
                display: none;
            }

            /* Make icons slightly smaller on mobile for better fit */
            .control-btn i {
                font-size: 1rem !important;
            }

            /* Adjust control button groups spacing */
            .controls > div {
                gap: 0.25rem;
            }

            /* Make time display wrap better */
            .controls .flex {
                flex-wrap: wrap;
            }
        }

        /* Extra small screens */
        @media (max-width: 640px) {
            .control-btn {
                min-width: 2.5rem;
                min-height: 2.5rem;
                padding: 0.4rem;
            }

            .control-btn i {
                font-size: 0.9rem !important;
            }

            #timeDisplay {
                font-size: 0.75rem;
                margin-left: 0.25rem;
            }

            #speedBtn span {
                font-size: 0.75rem;
            }

            .controls {
                padding: 0.5rem;
            }

            .progress-container {
                margin-bottom: 0.75rem;
            }
        }

        /* Focus Styles */
        *:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Video Element */
        #videoPlayer {
            width: 100%;
            height: 100%;
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-sm">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i class="fas fa-play-circle text-3xl text-blue-500"></i>
                <h1 class="text-2xl font-bold">Pro-Player HTML</h1>
            </div>
            <button id="themeToggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all" aria-label="Toggle Theme">
                <i class="fas fa-moon text-xl"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Player Column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Video Container -->
                <div id="videoContainer" class="video-container rounded-lg overflow-hidden shadow-xl">
                    <video id="videoPlayer" crossorigin="anonymous"></video>
                    
                    <!-- Spinner -->
                    <div id="spinner" class="spinner hidden"></div>
                    
                    <!-- Play Overlay -->
                    <div id="playOverlay" class="play-overlay">
                        <i class="fas fa-play text-4xl text-white"></i>
                    </div>
                    
                    <!-- Notification -->
                    <div id="notification" class="notification"></div>
                    
                    <!-- Controls -->
                    <div id="controls" class="controls glass">
                        <!-- Progress Bar -->
                        <div id="progressContainer" class="progress-container">
                            <div id="progressBuffered" class="progress-buffered"></div>
                            <div id="progressBar" class="progress-bar">
                                <div class="progress-handle"></div>
                            </div>
                            <div id="timeTooltip" class="time-tooltip"></div>
                        </div>
                        
                        <!-- Control Buttons -->
                        <div class="flex items-center justify-between gap-1 flex-wrap">
                            <!-- Left Controls -->
                            <div class="flex items-center gap-0.5 flex-shrink-0">
                                <button id="playPauseBtn" class="control-btn" aria-label="Play/Pause">
                                    <i class="fas fa-play text-xl"></i>
                                </button>
                                <button id="rewindBtn" class="control-btn" aria-label="Rewind 10 seconds">
                                    <i class="fas fa-backward text-lg"></i>
                                </button>
                                <button id="forwardBtn" class="control-btn" aria-label="Forward 10 seconds">
                                    <i class="fas fa-forward text-lg"></i>
                                </button>
                                
                                <!-- Volume Control -->
                                <div class="volume-control flex items-center">
                                    <button id="muteBtn" class="control-btn" aria-label="Mute/Unmute">
                                        <i class="fas fa-volume-up text-lg"></i>
                                    </button>
                                    <div class="volume-slider">
                                        <input type="range" id="volumeSlider" min="0" max="100" value="100" aria-label="Volume">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Time Display - Center on mobile -->
                            <span id="timeDisplay" class="text-white text-sm whitespace-nowrap flex-shrink-0 order-3 lg:order-none w-full lg:w-auto text-center lg:text-left lg:ml-2">00:00 / 00:00</span>
                            
                            <!-- Right Controls -->
                            <div class="flex items-center gap-0.5 ml-auto flex-shrink-0">
                                <!-- Speed Menu -->
                                <div class="relative">
                                    <button id="speedBtn" class="control-btn" aria-label="Playback Speed">
                                        <span class="text-sm font-semibold">1x</span>
                                    </button>
                                    <div id="speedMenu" class="popup-menu">
                                        <div class="popup-menu-item" data-speed="0.5">0.5x</div>
                                        <div class="popup-menu-item" data-speed="0.75">0.75x</div>
                                        <div class="popup-menu-item active" data-speed="1">1x</div>
                                        <div class="popup-menu-item" data-speed="1.25">1.25x</div>
                                        <div class="popup-menu-item" data-speed="1.5">1.5x</div>
                                        <div class="popup-menu-item" data-speed="2">2x</div>
                                    </div>
                                </div>
                                
                                <!-- Subtitle Menu -->
                                <div class="relative">
                                    <button id="subtitleBtn" class="control-btn" aria-label="Subtitles" disabled>
                                        <i class="fas fa-closed-captioning text-lg"></i>
                                    </button>
                                    <div id="subtitleMenu" class="popup-menu">
                                        <div class="popup-menu-item active" data-track="off">Off</div>
                                    </div>
                                </div>
                                
                                <button id="theaterBtn" class="control-btn hidden lg:flex" aria-label="Theater Mode">
                                    <i class="fas fa-expand-arrows-alt text-lg"></i>
                                </button>
                                
                                <button id="pipBtn" class="control-btn hidden sm:flex" aria-label="Picture in Picture">
                                    <i class="fas fa-external-link-alt text-lg"></i>
                                </button>
                                
                                <button id="fullscreenBtn" class="control-btn" aria-label="Fullscreen">
                                    <i class="fas fa-expand text-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Form -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Tambah Video</h2>
                    <form id="videoForm" class="space-y-4">
                        <div>
                            <label for="videoUrl" class="block text-sm font-medium mb-2">URL Video (MP4)</label>
                            <input type="url" id="videoUrl" placeholder="https://example.com/video.mp4" 
                                   class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all">
                            <p id="urlError" class="text-red-500 text-sm mt-1 hidden">URL video tidak boleh kosong</p>
                        </div>
                        <div>
                            <label for="subtitleUrl" class="block text-sm font-medium mb-2">URL Subtitle (VTT) - Opsional</label>
                            <input type="url" id="subtitleUrl" placeholder="https://example.com/subtitle.vtt" 
                                   class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        <div>
                            <label for="videoTitle" class="block text-sm font-medium mb-2">Judul Video</label>
                            <input type="text" id="videoTitle" placeholder="Judul video" 
                                   class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition-all active:scale-95">
                            <i class="fas fa-play mr-2"></i>Putar Video
                        </button>
                    </form>
                </div>
            </div>

            <!-- Sidebar (Desktop Only) -->
            <div class="hidden lg:block">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
                    <!-- Tab Buttons -->
                    <div class="flex border-b border-gray-200 dark:border-gray-700">
                        <button id="playlistTab" class="flex-1 py-3 px-4 font-semibold bg-blue-500 text-white transition-all">
                            Playlist
                        </button>
                        <button id="historyTab" class="flex-1 py-3 px-4 font-semibold hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                            Riwayat
                        </button>
                    </div>
                    
                    <!-- Playlist Panel -->
                    <div id="playlistPanel" class="p-4">
                        <div id="playlistList" class="space-y-2 max-h-96 overflow-y-auto"></div>
                        <p id="playlistEmpty" class="text-gray-500 text-center py-8">Belum ada video</p>
                    </div>
                    
                    <!-- History Panel -->
                    <div id="historyPanel" class="p-4 hidden">
                        <div id="historyList" class="space-y-2 max-h-96 overflow-y-auto"></div>
                        <p id="historyEmpty" class="text-gray-500 text-center py-8">Belum ada riwayat</p>
                        <button id="clearDataBtn" class="w-full mt-4 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg transition-all">
                            <i class="fas fa-trash mr-2"></i>Hapus Semua Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Floating Buttons -->
    <div id="mobilePlaylistBtn" class="mobile-btn mobile-btn-playlist" aria-label="Open Playlist">
        <i class="fas fa-list text-xl"></i>
    </div>
    <div id="mobileHistoryBtn" class="mobile-btn mobile-btn-history" aria-label="Open History">
        <i class="fas fa-history text-xl"></i>
    </div>

    <!-- Mobile Modal -->
    <div id="mobileModal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 id="modalTitle" class="text-lg font-semibold">Playlist</h3>
                <button id="closeModalBtn" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all" aria-label="Close Modal">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modalBody" class="flex-1 overflow-y-auto p-4"></div>
        </div>
    </div>

    <!-- Templates -->
    <template id="playlistItemTemplate">
        <div class="playlist-item bg-gray-50 dark:bg-gray-700 rounded-lg p-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-all">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <h4 class="font-medium truncate playlist-item-title">Video Title</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400 playlist-item-duration">00:00</p>
                </div>
                <button class="playlist-item-delete p-2 hover:bg-red-500 hover:text-white rounded-lg transition-all ml-2" aria-label="Delete">
                    <i class="fas fa-trash text-sm"></i>
                </button>
            </div>
        </div>
    </template>

    <template id="historyItemTemplate">
        <div class="history-item bg-gray-50 dark:bg-gray-700 rounded-lg p-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-all">
            <h4 class="font-medium truncate history-item-title">Video Title</h4>
            <p class="text-sm text-gray-500 dark:text-gray-400 history-item-time">Watched: --</p>
        </div>
    </template>

    <script type="module">
        // ===== STATE MANAGEMENT =====
        const state = {
            playlist: [],
            history: [],
            currentVideoIndex: -1,
            preferences: {
                theme: 'dark',
                volume: 100,
                playbackRate: 1
            },
            isTheaterMode: false,
            isMobile: window.matchMedia("(max-width: 1024px)").matches,
            controlsTimeout: null,
            isDraggingProgress: false
        };

        // ===== DOM ELEMENTS =====
        const els = {
            // Video
            video: document.getElementById('videoPlayer'),
            videoContainer: document.getElementById('videoContainer'),
            
            // Overlays
            playOverlay: document.getElementById('playOverlay'),
            spinner: document.getElementById('spinner'),
            notification: document.getElementById('notification'),
            
            // Controls
            controls: document.getElementById('controls'),
            playPauseBtn: document.getElementById('playPauseBtn'),
            rewindBtn: document.getElementById('rewindBtn'),
            forwardBtn: document.getElementById('forwardBtn'),
            muteBtn: document.getElementById('muteBtn'),
            volumeSlider: document.getElementById('volumeSlider'),
            timeDisplay: document.getElementById('timeDisplay'),
            
            // Progress
            progressContainer: document.getElementById('progressContainer'),
            progressBar: document.getElementById('progressBar'),
            progressBuffered: document.getElementById('progressBuffered'),
            timeTooltip: document.getElementById('timeTooltip'),
            
            // Menus
            speedBtn: document.getElementById('speedBtn'),
            speedMenu: document.getElementById('speedMenu'),
            subtitleBtn: document.getElementById('subtitleBtn'),
            subtitleMenu: document.getElementById('subtitleMenu'),
            
            // Other buttons
            theaterBtn: document.getElementById('theaterBtn'),
            pipBtn: document.getElementById('pipBtn'),
            fullscreenBtn: document.getElementById('fullscreenBtn'),
            themeToggle: document.getElementById('themeToggle'),
            
            // Form
            videoForm: document.getElementById('videoForm'),
            videoUrl: document.getElementById('videoUrl'),
            subtitleUrl: document.getElementById('subtitleUrl'),
            videoTitle: document.getElementById('videoTitle'),
            urlError: document.getElementById('urlError'),
            
            // Sidebar
            playlistTab: document.getElementById('playlistTab'),
            historyTab: document.getElementById('historyTab'),
            playlistPanel: document.getElementById('playlistPanel'),
            historyPanel: document.getElementById('historyPanel'),
            playlistList: document.getElementById('playlistList'),
            historyList: document.getElementById('historyList'),
            playlistEmpty: document.getElementById('playlistEmpty'),
            historyEmpty: document.getElementById('historyEmpty'),
            clearDataBtn: document.getElementById('clearDataBtn'),
            
            // Mobile
            mobilePlaylistBtn: document.getElementById('mobilePlaylistBtn'),
            mobileHistoryBtn: document.getElementById('mobileHistoryBtn'),
            mobileModal: document.getElementById('mobileModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalBody: document.getElementById('modalBody'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            
            // Templates
            playlistItemTemplate: document.getElementById('playlistItemTemplate'),
            historyItemTemplate: document.getElementById('historyItemTemplate')
        };

        // ===== STORAGE FUNCTIONS =====
        function saveToStorage() {
            localStorage.setItem('proPlayerPlaylist', JSON.stringify(state.playlist));
            localStorage.setItem('proPlayerHistory', JSON.stringify(state.history));
            localStorage.setItem('proPlayerPreferences', JSON.stringify(state.preferences));
        }

        function loadFromStorage() {
            const playlist = localStorage.getItem('proPlayerPlaylist');
            const history = localStorage.getItem('proPlayerHistory');
            const preferences = localStorage.getItem('proPlayerPreferences');
            
            if (playlist) state.playlist = JSON.parse(playlist);
            if (history) state.history = JSON.parse(history);
            if (preferences) {
                state.preferences = JSON.parse(preferences);
                applyPreferences();
            }
        }

        function applyPreferences() {
            // Apply theme
            if (state.preferences.theme === 'dark') {
                document.documentElement.classList.add('dark');
                els.themeToggle.innerHTML = '<i class="fas fa-sun text-xl"></i>';
            } else {
                document.documentElement.classList.remove('dark');
                els.themeToggle.innerHTML = '<i class="fas fa-moon text-xl"></i>';
            }
            
            // Apply volume
            els.video.volume = state.preferences.volume / 100;
            els.volumeSlider.value = state.preferences.volume;
            updateVolumeIcon();
            
            // Apply playback rate
            els.video.playbackRate = state.preferences.playbackRate;
        }

        // ===== UTILITY FUNCTIONS =====
        function formatTime(seconds) {
            if (isNaN(seconds)) return '00:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function showNotification(message, duration = 2000) {
            els.notification.textContent = message;
            els.notification.classList.add('show');
            setTimeout(() => {
                els.notification.classList.remove('show');
            }, duration);
        }

        function showSpinner() {
            els.spinner.classList.remove('hidden');
        }

        function hideSpinner() {
            els.spinner.classList.add('hidden');
        }

        // ===== VIDEO FUNCTIONS =====
        function loadVideo(video, autoplay = true) {
            // Reset video state
            els.video.src = video.url;
            
            // Remove existing subtitle tracks
            const tracks = els.video.querySelectorAll('track');
            tracks.forEach(track => track.remove());
            
            // Add subtitle if provided
            if (video.subtitleUrl) {
                const track = document.createElement('track');
                track.kind = 'subtitles';
                track.label = 'Subtitle';
                track.srclang = 'id';
                track.src = video.subtitleUrl;
                els.video.appendChild(track);
                
                els.subtitleBtn.disabled = false;
                updateSubtitleMenu();
            } else {
                els.subtitleBtn.disabled = true;
            }
            
            // Show spinner
            showSpinner();
            
            // Load and play
            els.video.load();
            
            if (autoplay) {
                const playPromise = els.video.play();
                if (playPromise !== undefined) {
                    playPromise.catch(err => {
                        console.log('Autoplay prevented:', err);
                        showNotification('Klik tombol play untuk memulai');
                    });
                }
            }
            
            // Add to history
            addToHistory(video);
        }

        function playVideoAtIndex(index) {
            if (index >= 0 && index < state.playlist.length) {
                state.currentVideoIndex = index;
                loadVideo(state.playlist[index]);
                renderPlaylist();
            }
        }

        function playNextVideo() {
            if (state.currentVideoIndex < state.playlist.length - 1) {
                playVideoAtIndex(state.currentVideoIndex + 1);
                showNotification('Memutar video berikutnya');
            }
        }

        function addToHistory(video) {
            const existingIndex = state.history.findIndex(h => h.url === video.url);
            const historyItem = {
                ...video,
                watchedAt: new Date().toISOString()
            };
            
            if (existingIndex !== -1) {
                state.history[existingIndex] = historyItem;
            } else {
                state.history.unshift(historyItem);
            }
            
            // Limit history to 50 items
            if (state.history.length > 50) {
                state.history = state.history.slice(0, 50);
            }
            
            saveToStorage();
            renderHistory();
        }

        // ===== CONTROLS VISIBILITY =====
        function showControls() {
            els.controls.classList.remove('hidden');
            els.videoContainer.style.cursor = 'default';
            
            if (!state.isMobile && !els.video.paused) {
                clearTimeout(state.controlsTimeout);
                state.controlsTimeout = setTimeout(() => {
                    hideControls();
                }, 3000);
            }
        }

        function hideControls() {
            if (!state.isMobile && !els.video.paused) {
                els.controls.classList.add('hidden');
                els.videoContainer.style.cursor = 'none';
            }
        }

        function toggleControls() {
            if (els.controls.classList.contains('hidden')) {
                showControls();
            } else {
                els.controls.classList.add('hidden');
            }
        }

        // ===== PLAY/PAUSE =====
        function togglePlayPause() {
            if (els.video.paused) {
                els.video.play();
            } else {
                els.video.pause();
            }
        }

        function updatePlayPauseButton() {
            const icon = els.playPauseBtn.querySelector('i');
            if (els.video.paused) {
                icon.className = 'fas fa-play text-xl';
                els.playOverlay.classList.remove('hidden');
            } else {
                icon.className = 'fas fa-pause text-xl';
                els.playOverlay.classList.add('hidden');
            }
        }

        // ===== VOLUME =====
        function toggleMute() {
            els.video.muted = !els.video.muted;
            updateVolumeIcon();
        }

        function updateVolumeIcon() {
            const icon = els.muteBtn.querySelector('i');
            if (els.video.muted || els.video.volume === 0) {
                icon.className = 'fas fa-volume-mute text-lg';
            } else if (els.video.volume < 0.5) {
                icon.className = 'fas fa-volume-down text-lg';
            } else {
                icon.className = 'fas fa-volume-up text-lg';
            }
        }

        // ===== PROGRESS BAR =====
        function updateProgress() {
            if (state.isDraggingProgress) return;
            
            const percent = (els.video.currentTime / els.video.duration) * 100;
            els.progressBar.style.width = `${percent}%`;
            
            // Update buffered
            if (els.video.buffered.length > 0) {
                const bufferedEnd = els.video.buffered.end(els.video.buffered.length - 1);
                const bufferedPercent = (bufferedEnd / els.video.duration) * 100;
                els.progressBuffered.style.width = `${bufferedPercent}%`;
            }
            
            // Update time display
            els.timeDisplay.textContent = `${formatTime(els.video.currentTime)} / ${formatTime(els.video.duration)}`;
        }

        function seekVideo(e) {
            const rect = els.progressContainer.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            const time = percent * els.video.duration;
            els.video.currentTime = time;
        }

        // ===== SPEED CONTROL =====
        function toggleSpeedMenu() {
            els.speedMenu.classList.toggle('show');
            els.subtitleMenu.classList.remove('show');
        }

        function setPlaybackSpeed(speed) {
            els.video.playbackRate = speed;
            state.preferences.playbackRate = speed;
            els.speedBtn.querySelector('span').textContent = `${speed}x`;
            saveToStorage();
            showNotification(`Kecepatan ${speed}x`);
            
            // Update active state
            els.speedMenu.querySelectorAll('.popup-menu-item').forEach(item => {
                if (parseFloat(item.dataset.speed) === speed) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            els.speedMenu.classList.remove('show');
        }

        // ===== SUBTITLE CONTROL =====
        function toggleSubtitleMenu() {
            els.subtitleMenu.classList.toggle('show');
            els.speedMenu.classList.remove('show');
        }

        function updateSubtitleMenu() {
            // Clear existing items except "Off"
            els.subtitleMenu.innerHTML = '<div class="popup-menu-item active" data-track="off">Off</div>';
            
            const tracks = els.video.textTracks;
            for (let i = 0; i < tracks.length; i++) {
                const item = document.createElement('div');
                item.className = 'popup-menu-item';
                item.dataset.track = i;
                item.textContent = tracks[i].label || `Subtitle ${i + 1}`;
                els.subtitleMenu.appendChild(item);
                
                // Add click listener
                item.addEventListener('click', () => {
                    setSubtitleTrack(i);
                });
            }
        }

        function setSubtitleTrack(index) {
            const tracks = els.video.textTracks;
            
            if (index === 'off') {
                for (let i = 0; i < tracks.length; i++) {
                    tracks[i].mode = 'hidden';
                }
                showNotification('Subtitle dimatikan');
            } else {
                for (let i = 0; i < tracks.length; i++) {
                    tracks[i].mode = i === index ? 'showing' : 'hidden';
                }
                showNotification('Subtitle diaktifkan');
            }
            
            // Update active state
            els.subtitleMenu.querySelectorAll('.popup-menu-item').forEach(item => {
                if (item.dataset.track == index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            els.subtitleMenu.classList.remove('show');
        }

        // ===== THEATER MODE =====
        function toggleTheaterMode() {
            state.isTheaterMode = !state.isTheaterMode;
            els.videoContainer.classList.toggle('theater-mode');
            
            const icon = els.theaterBtn.querySelector('i');
            if (state.isTheaterMode) {
                icon.className = 'fas fa-compress-arrows-alt text-lg';
                showNotification('Mode Teater');
            } else {
                icon.className = 'fas fa-expand-arrows-alt text-lg';
                showNotification('Mode Normal');
            }
        }

        // ===== PICTURE IN PICTURE =====
        async function togglePiP() {
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                } else {
                    await els.video.requestPictureInPicture();
                }
            } catch (err) {
                showNotification('PiP tidak didukung');
            }
        }

        // ===== FULLSCREEN =====
        async function toggleFullscreen() {
            if (!document.fullscreenElement) {
                try {
                    // Request fullscreen on video element instead for better mobile support
                    if (state.isMobile && els.video.webkitEnterFullscreen) {
                        // iOS Safari - uses native video fullscreen (always landscape)
                        els.video.webkitEnterFullscreen();
                    } else {
                        // Standard fullscreen API
                        await els.videoContainer.requestFullscreen();
                        
                        // Try to lock orientation to landscape
                        if (state.isMobile && screen.orientation && screen.orientation.lock) {
                            try {
                                await screen.orientation.lock('landscape').catch(() => {
                                    // Silently fail if lock is not supported
                                    console.log('Orientation lock not available');
                                });
                            } catch (err) {
                                console.log('Screen orientation lock failed:', err);
                            }
                        }
                    }
                } catch (err) {
                    console.error('Fullscreen error:', err);
                }
            } else {
                try {
                    await document.exitFullscreen();
                    
                    // Unlock orientation when exiting fullscreen
                    if (state.isMobile && screen.orientation && screen.orientation.unlock) {
                        screen.orientation.unlock();
                    }
                } catch (err) {
                    console.error('Exit fullscreen error:', err);
                }
            }
        }

        function updateFullscreenButton() {
            const icon = els.fullscreenBtn.querySelector('i');
            if (document.fullscreenElement) {
                icon.className = 'fas fa-compress text-lg';
            } else {
                icon.className = 'fas fa-expand text-lg';
                
                // Unlock orientation when exiting fullscreen
                if (state.isMobile && screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                }
            }
        }

        // ===== THEME TOGGLE =====
        function toggleTheme() {
            state.preferences.theme = state.preferences.theme === 'dark' ? 'light' : 'dark';
            applyPreferences();
            saveToStorage();
        }

        // ===== PLAYLIST MANAGEMENT =====
        function addToPlaylist(video) {
            state.playlist.push(video);
            saveToStorage();
            renderPlaylist();
        }

        function removeFromPlaylist(index) {
            state.playlist.splice(index, 1);
            
            // Adjust current video index
            if (state.currentVideoIndex === index) {
                state.currentVideoIndex = -1;
            } else if (state.currentVideoIndex > index) {
                state.currentVideoIndex--;
            }
            
            saveToStorage();
            renderPlaylist();
        }

        function renderPlaylist() {
            els.playlistList.innerHTML = '';
            
            if (state.playlist.length === 0) {
                els.playlistEmpty.classList.remove('hidden');
                return;
            }
            
            els.playlistEmpty.classList.add('hidden');
            
            state.playlist.forEach((video, index) => {
                const clone = els.playlistItemTemplate.content.cloneNode(true);
                const item = clone.querySelector('.playlist-item');
                const title = clone.querySelector('.playlist-item-title');
                const duration = clone.querySelector('.playlist-item-duration');
                const deleteBtn = clone.querySelector('.playlist-item-delete');
                
                title.textContent = video.title || `Video ${index + 1}`;
                duration.textContent = video.duration || '--:--';
                
                // Highlight current video
                if (index === state.currentVideoIndex) {
                    item.classList.add('ring-2', 'ring-blue-500');
                }
                
                // Click to play
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.playlist-item-delete')) {
                        playVideoAtIndex(index);
                    }
                });
                
                // Delete button
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeFromPlaylist(index);
                });
                
                els.playlistList.appendChild(clone);
            });
        }

        function renderHistory() {
            els.historyList.innerHTML = '';
            
            if (state.history.length === 0) {
                els.historyEmpty.classList.remove('hidden');
                return;
            }
            
            els.historyEmpty.classList.add('hidden');
            
            state.history.forEach((video, index) => {
                const clone = els.historyItemTemplate.content.cloneNode(true);
                const item = clone.querySelector('.history-item');
                const title = clone.querySelector('.history-item-title');
                const time = clone.querySelector('.history-item-time');
                
                title.textContent = video.title || 'Video';
                
                const date = new Date(video.watchedAt);
                time.textContent = `Ditonton: ${date.toLocaleDateString('id-ID')} ${date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
                
                // Click to replay
                item.addEventListener('click', () => {
                    const playlistIndex = state.playlist.findIndex(v => v.url === video.url);
                    if (playlistIndex !== -1) {
                        playVideoAtIndex(playlistIndex);
                    } else {
                        addToPlaylist(video);
                        playVideoAtIndex(state.playlist.length - 1);
                    }
                });
                
                els.historyList.appendChild(clone);
            });
        }

        // ===== TAB SWITCHING =====
        function showPlaylistTab() {
            els.playlistTab.classList.add('bg-blue-500', 'text-white');
            els.playlistTab.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
            els.historyTab.classList.remove('bg-blue-500', 'text-white');
            els.historyTab.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
            
            els.playlistPanel.classList.remove('hidden');
            els.historyPanel.classList.add('hidden');
        }

        function showHistoryTab() {
            els.historyTab.classList.add('bg-blue-500', 'text-white');
            els.historyTab.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
            els.playlistTab.classList.remove('bg-blue-500', 'text-white');
            els.playlistTab.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
            
            els.historyPanel.classList.remove('hidden');
            els.playlistPanel.classList.add('hidden');
        }

        // ===== MOBILE MODAL =====
        function openModal(type) {
            els.mobileModal.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            if (type === 'playlist') {
                els.modalTitle.textContent = 'Playlist';
                els.modalBody.innerHTML = '';
                els.modalBody.appendChild(els.playlistPanel.cloneNode(true));
                
                // Re-render and re-attach listeners
                const clonedList = els.modalBody.querySelector('#playlistList');
                clonedList.innerHTML = '';
                
                state.playlist.forEach((video, index) => {
                    const clone = els.playlistItemTemplate.content.cloneNode(true);
                    const item = clone.querySelector('.playlist-item');
                    const title = clone.querySelector('.playlist-item-title');
                    const duration = clone.querySelector('.playlist-item-duration');
                    const deleteBtn = clone.querySelector('.playlist-item-delete');
                    
                    title.textContent = video.title || `Video ${index + 1}`;
                    duration.textContent = video.duration || '--:--';
                    
                    if (index === state.currentVideoIndex) {
                        item.classList.add('ring-2', 'ring-blue-500');
                    }
                    
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('.playlist-item-delete')) {
                            playVideoAtIndex(index);
                            closeModal();
                        }
                    });
                    
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeFromPlaylist(index);
                        openModal('playlist'); // Refresh
                    });
                    
                    clonedList.appendChild(clone);
                });
            } else if (type === 'history') {
                els.modalTitle.textContent = 'Riwayat';
                els.modalBody.innerHTML = '';
                els.modalBody.appendChild(els.historyPanel.cloneNode(true));
                
                // Re-render and re-attach listeners
                const clonedList = els.modalBody.querySelector('#historyList');
                clonedList.innerHTML = '';
                
                state.history.forEach((video, index) => {
                    const clone = els.historyItemTemplate.content.cloneNode(true);
                    const item = clone.querySelector('.history-item');
                    const title = clone.querySelector('.history-item-title');
                    const time = clone.querySelector('.history-item-time');
                    
                    title.textContent = video.title || 'Video';
                    
                    const date = new Date(video.watchedAt);
                    time.textContent = `Ditonton: ${date.toLocaleDateString('id-ID')} ${date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
                    
                    item.addEventListener('click', () => {
                        const playlistIndex = state.playlist.findIndex(v => v.url === video.url);
                        if (playlistIndex !== -1) {
                            playVideoAtIndex(playlistIndex);
                        } else {
                            addToPlaylist(video);
                            playVideoAtIndex(state.playlist.length - 1);
                        }
                        closeModal();
                    });
                    
                    clonedList.appendChild(clone);
                });
                
                // Clear data button
                const clearBtn = els.modalBody.querySelector('#clearDataBtn');
                clearBtn.addEventListener('click', clearAllData);
            }
            
            // Focus trap
            const focusableElements = els.mobileModal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];
            
            firstFocusable?.focus();
        }

        function closeModal() {
            els.mobileModal.classList.remove('show');
            document.body.style.overflow = '';
        }

        // ===== CLEAR DATA =====
        function clearAllData() {
            if (confirm('Hapus semua data playlist dan riwayat?')) {
                state.playlist = [];
                state.history = [];
                state.currentVideoIndex = -1;
                saveToStorage();
                renderPlaylist();
                renderHistory();
                showNotification('Semua data telah dihapus');
                closeModal();
            }
        }

        // ===== FORM SUBMISSION =====
        els.videoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const url = els.videoUrl.value.trim();
            const subtitleUrl = els.subtitleUrl.value.trim();
            const title = els.videoTitle.value.trim() || 'Video Tanpa Judul';
            
            // Validation
            if (!url) {
                els.urlError.classList.remove('hidden');
                els.videoUrl.focus();
                return;
            }
            
            els.urlError.classList.add('hidden');
            
            const video = {
                url,
                subtitleUrl: subtitleUrl || null,
                title,
                duration: null
            };
            
            addToPlaylist(video);
            playVideoAtIndex(state.playlist.length - 1);
            
            // Reset form
            els.videoForm.reset();
        });

        // ===== EVENT LISTENERS =====
        
        // Video Events
        els.video.addEventListener('loadstart', () => {
            showSpinner();
        });

        els.video.addEventListener('canplay', () => {
            hideSpinner();
        });

        els.video.addEventListener('play', () => {
            updatePlayPauseButton();
            if (!state.isMobile) {
                showControls();
            }
        });

        els.video.addEventListener('pause', () => {
            updatePlayPauseButton();
            showControls();
        });

        els.video.addEventListener('timeupdate', updateProgress);

        els.video.addEventListener('volumechange', updateVolumeIcon);

        els.video.addEventListener('ended', () => {
            playNextVideo();
        });

        els.video.addEventListener('error', (e) => {
            hideSpinner();
            showNotification('Gagal memuat video. Periksa URL atau masalah CORS.', 4000);
            els.playOverlay.classList.remove('hidden');
            console.error('Video error:', e);
        });

        els.video.addEventListener('loadedmetadata', () => {
            // Update duration in playlist
            if (state.currentVideoIndex !== -1) {
                state.playlist[state.currentVideoIndex].duration = formatTime(els.video.duration);
                saveToStorage();
                renderPlaylist();
            }
        });

        // Subtitle error handling
        els.video.addEventListener('error', (e) => {
            if (e.target.tagName === 'TRACK') {
                showNotification('Gagal memuat subtitle', 3000);
                els.subtitleBtn.disabled = true;
            }
        }, true);

        // Control Buttons
        els.playPauseBtn.addEventListener('click', togglePlayPause);
        els.playOverlay.addEventListener('click', togglePlayPause);
        els.rewindBtn.addEventListener('click', () => {
            els.video.currentTime = Math.max(0, els.video.currentTime - 10);
        });
        els.forwardBtn.addEventListener('click', () => {
            els.video.currentTime = Math.min(els.video.duration, els.video.currentTime + 10);
        });
        els.muteBtn.addEventListener('click', toggleMute);
        els.volumeSlider.addEventListener('input', (e) => {
            els.video.volume = e.target.value / 100;
            els.video.muted = false;
            state.preferences.volume = parseInt(e.target.value);
            saveToStorage();
        });

        // Speed and Subtitle
        els.speedBtn.addEventListener('click', toggleSpeedMenu);
        els.speedMenu.addEventListener('click', (e) => {
            if (e.target.classList.contains('popup-menu-item')) {
                setPlaybackSpeed(parseFloat(e.target.dataset.speed));
            }
        });
        els.subtitleBtn.addEventListener('click', toggleSubtitleMenu);
        els.subtitleMenu.addEventListener('click', (e) => {
            if (e.target.classList.contains('popup-menu-item')) {
                setSubtitleTrack(e.target.dataset.track === 'off' ? 'off' : parseInt(e.target.dataset.track));
            }
        });

        // Other controls
        els.theaterBtn.addEventListener('click', toggleTheaterMode);
        els.pipBtn.addEventListener('click', togglePiP);
        els.fullscreenBtn.addEventListener('click', toggleFullscreen);

        // Progress Bar
        els.progressContainer.addEventListener('click', seekVideo);
        els.progressContainer.addEventListener('mousedown', (e) => {
            state.isDraggingProgress = true;
            seekVideo(e);
        });
        document.addEventListener('mousemove', (e) => {
            if (state.isDraggingProgress) {
                seekVideo(e);
            }
            
            // Show tooltip
            if (e.target === els.progressContainer || els.progressContainer.contains(e.target)) {
                const rect = els.progressContainer.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                const time = percent * els.video.duration;
                els.timeTooltip.textContent = formatTime(time);
                els.timeTooltip.style.left = `${e.clientX - rect.left}px`;
            }
        });
        document.addEventListener('mouseup', () => {
            state.isDraggingProgress = false;
        });

        // Touch support for progress
        els.progressContainer.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            const rect = els.progressContainer.getBoundingClientRect();
            const percent = (touch.clientX - rect.left) / rect.width;
            const time = percent * els.video.duration;
            els.video.currentTime = time;
        });

        // Controls visibility (Desktop)
        if (!state.isMobile) {
            els.videoContainer.addEventListener('mousemove', showControls);
            els.videoContainer.addEventListener('mouseleave', hideControls);
        }

        // Controls visibility (Mobile - tap to toggle)
        if (state.isMobile) {
            els.videoContainer.addEventListener('click', (e) => {
                if (e.target === els.video || e.target === els.videoContainer) {
                    toggleControls();
                }
            });
        }

        // Fullscreen change
        document.addEventListener('fullscreenchange', updateFullscreenButton);

        // Theme toggle
        els.themeToggle.addEventListener('click', toggleTheme);

        // Tabs
        els.playlistTab.addEventListener('click', showPlaylistTab);
        els.historyTab.addEventListener('click', showHistoryTab);

        // Clear data
        els.clearDataBtn.addEventListener('click', clearAllData);

        // Mobile buttons
        els.mobilePlaylistBtn.addEventListener('click', () => openModal('playlist'));
        els.mobileHistoryBtn.addEventListener('click', () => openModal('history'));
        els.closeModalBtn.addEventListener('click', closeModal);
        els.mobileModal.addEventListener('click', (e) => {
            if (e.target === els.mobileModal) {
                closeModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger when typing in inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key) {
                case ' ':
                case 'k':
                    e.preventDefault();
                    togglePlayPause();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    els.video.currentTime = Math.max(0, els.video.currentTime - 5);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    els.video.currentTime = Math.min(els.video.duration, els.video.currentTime + 5);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    els.video.volume = Math.min(1, els.video.volume + 0.1);
                    els.volumeSlider.value = els.video.volume * 100;
                    state.preferences.volume = els.video.volume * 100;
                    saveToStorage();
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    els.video.volume = Math.max(0, els.video.volume - 0.1);
                    els.volumeSlider.value = els.video.volume * 100;
                    state.preferences.volume = els.video.volume * 100;
                    saveToStorage();
                    break;
                case 'm':
                    toggleMute();
                    break;
                case 'f':
                    toggleFullscreen();
                    break;
                case 't':
                    toggleTheaterMode();
                    break;
            }
        });

        // Responsive detection
        window.matchMedia("(max-width: 1024px)").addEventListener('change', (e) => {
            state.isMobile = e.matches;
            
            if (state.isMobile) {
                // Mobile: always show controls
                els.controls.classList.remove('hidden');
                els.videoContainer.style.cursor = 'default';
            } else {
                // Desktop: auto-hide behavior
                if (!els.video.paused) {
                    showControls();
                }
            }
        });

        // Close menus when clicking outside
        document.addEventListener('click', (e) => {
            if (!els.speedBtn.contains(e.target) && !els.speedMenu.contains(e.target)) {
                els.speedMenu.classList.remove('show');
            }
            if (!els.subtitleBtn.contains(e.target) && !els.subtitleMenu.contains(e.target)) {
                els.subtitleMenu.classList.remove('show');
            }
        });

        // ===== INITIALIZATION =====
        function init() {
            // Load data from storage
            loadFromStorage();
            
            // Render UI
            renderPlaylist();
            renderHistory();
            
            // Set initial state
            showControls();
            
            // Log ready
            console.log('Pro-Player HTML vMaster 3.0 Ready!');
        }

        // Start the application
        init();
    </script>
</body>
</html>
